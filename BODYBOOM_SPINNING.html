<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BODYBOOM SPINNING 자리 예약</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 0;
    }
    h2 {
      text-align: center;
      font-size: 1.6rem;
      font-weight: 900;
      margin-top: 20px;
    }
    #countdown {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #d32f2f;
    }
    #container {
      max-width: 400px;
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }
    .row {
      display: flex;
      gap: 10px;
      justify-content: center;
      min-width: 300px;
    }
    .seat {
      width: 50px;
      height: 50px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      user-select: none;
      cursor: pointer;
      transition: background-color 0.3s;
      position: relative;
    }
    .seat.reserved {
      background-color: #4caf50;
      color: white;
    }
    table {
      margin: 30px auto;
      width: 90%;
      max-width: 500px;
      border-collapse: collapse;
      text-align: center;
      font-size: 0.8rem;
    }
    table, th, td {
      border: 1px solid #444;
    }
    th, td {
      padding: 6px 8px;
    }
    thead {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

<h2>BODYBOOM SPINNING<br />자리 예약</h2>
<div id="countdown"></div>
<div id="container"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB9v97oeQISiV1P3k6EeFl_n0zeRv-aMsE",
    authDomain: "spinning-120fe.firebaseapp.com",
    projectId: "spinning-120fe",
    storageBucket: "spinning-120fe.appspot.com",
    messagingSenderId: "246146727087",
    appId: "1:246146727087:web:94ae386984114c478c285a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const container = document.getElementById("container");
  const seatRows = [
    [1, 2, 3, 4, 5],
    [6, 7, 8, 9, 10, 11],
    [12, 13, 14, 15, 16, 17],
    [18, 19, 20, 21, 22]
  ];

  let currentUserUID = null;

  firebase.auth().signInAnonymously().then(userCredential => {
    currentUserUID = userCredential.user.uid;
    loadSeatsRealtime();
    updateCountdown();
  }).catch(error => {
    console.error("익명 로그인 실패:", error);
    alert("인증 실패: 페이지를 새로고침 해주세요.");
  });

  function getTodayStr() {
    return new Date().toISOString().slice(0, 10);
  }

  function checkReservationAllowed() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const min = now.getMinutes();
    if (day === 0 || day === 6) return false;
    const totalMin = hour * 60 + min;
    const morningStart = 9 * 60 + 30;
    const morningEnd = 10 * 60 + 30;
    if (totalMin >= morningStart && totalMin < morningEnd) return true;
    if ([1, 3, 5].includes(day)) {
      const eveningStart = 19 * 60;
      const eveningEnd = 20 * 60;
      if (totalMin >= eveningStart && totalMin < eveningEnd) return true;
    }
    if ([2, 4].includes(day)) {
      const eveningStart = 20 * 60;
      const eveningEnd = 21 * 60;
      if (totalMin >= eveningStart && totalMin < eveningEnd) return true;
    }
    return false;
  }

  function loadSeatsRealtime() {
    const todayStr = getTodayStr();
    const seatsRef = db.collection("reservations").doc(todayStr).collection("seats");
    seatsRef.onSnapshot(snapshot => {
      const reservedSeats = {};
      snapshot.forEach(doc => {
        reservedSeats[doc.id] = doc.data();
      });
      renderSeats(reservedSeats);
    });
  }

  function renderSeats(reservedSeats) {
    container.innerHTML = "";
    const isReservationTime = checkReservationAllowed();

    seatRows.forEach(row => {
      const rowDiv = document.createElement("div");
      rowDiv.className = "row";

      row.forEach(seatNum => {
        const seatDiv = document.createElement("div");
        seatDiv.className = "seat";
        seatDiv.dataset.number = seatNum;
        seatDiv.textContent = seatNum;

        if (reservedSeats[seatNum]) {
          seatDiv.classList.add("reserved");
          seatDiv.textContent = reservedSeats[seatNum].name;
          seatDiv.dataset.name = reservedSeats[seatNum].name;
          seatDiv.dataset.pw = reservedSeats[seatNum].pw;
          seatDiv.dataset.uid = reservedSeats[seatNum].uid;
        }

        // ❗예약 불가능한 시간에는 클릭 비활성화 + 흐리게 표시
        if (!isReservationTime && !reservedSeats[seatNum]) {
          seatDiv.style.pointerEvents = "none";
          seatDiv.style.opacity = "0.4";
        }

        seatDiv.addEventListener("click", () => reserveSeat(seatDiv));
        rowDiv.appendChild(seatDiv);
      });

      container.appendChild(rowDiv);
    });
  }

  async function reserveSeat(div) {
    const seatNum = div.dataset.number;
    const todayStr = getTodayStr();
    const seatsRef = db.collection("reservations").doc(todayStr).collection("seats");

    if (div.classList.contains("reserved")) {
      const inputPw = prompt("예약 취소를 위해 비밀번호 4자리를 입력하세요:");
      if (inputPw === div.dataset.pw) {
        await seatsRef.doc(seatNum).delete();
        alert("예약이 취소되었습니다.");
      } else {
        alert("비밀번호가 틀렸습니다.");
      }
      return;
    }

    if (!checkReservationAllowed()) {
      alert("지금은 예약 시간이 아닙니다.");
      return;
    }

    const snapshot = await seatsRef.get();
    let alreadyReserved = null;
    snapshot.forEach(doc => {
      if (doc.data().uid === currentUserUID) {
        alreadyReserved = doc.id;
      }
    });

    if (alreadyReserved) {
      alert(`이미 예약한 자리가 있습니다. (좌석 번호: ${alreadyReserved})`);
      return;
    }

    const name = prompt("예약자 이름을 입력하세요:");
    if (!name) return alert("이름을 입력해야 예약할 수 있습니다.");

    let pw;
    do {
      pw = prompt("예약 비밀번호 4자리를 숫자로 입력하세요:");
      if (pw === null) return alert("비밀번호를 입력해야 예약할 수 있습니다.");
    } while (!/^\d{4}$/.test(pw));

    await seatsRef.doc(seatNum).set({ name, pw, uid: currentUserUID });
    alert("예약이 완료되었습니다.");
  }

  function updateCountdown() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const min = now.getMinutes();
    const sec = now.getSeconds();
    const totalSecNow = hour * 3600 + min * 60 + sec;

    const times = [];
    const morningStart = 9 * 3600 + 30 * 60;
    if (day >= 1 && day <= 5 && totalSecNow < morningStart) {
      times.push(morningStart);
    }

    if ([1, 3, 5].includes(day)) {
      const eveningStart = 19 * 3600;
      if (totalSecNow < eveningStart) times.push(eveningStart);
    } else if ([2, 4].includes(day)) {
      const eveningStart = 20 * 3600;
      if (totalSecNow < eveningStart) times.push(eveningStart);
    }

    const countdown = document.getElementById("countdown");

    if (times.length === 0) {
      countdown.textContent = "지금은 예약이 불가능한 시간입니다.";
      return;
    }

    const next = Math.min(...times);
    const diff = next - totalSecNow;
    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;

    let text = `예약 가능까지 `;
    if (hours > 0) text += `${hours}시간 `;
    if (minutes > 0 || hours > 0) text += `${minutes}분 `;
    text += `${seconds}초 남았습니다`;

    countdown.textContent = text;
  }

  setInterval(updateCountdown, 1000);
</script>

</body>
</html>
